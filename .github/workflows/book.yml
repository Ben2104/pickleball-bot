name: Automatic Pickleball Reservations on PlayByPoint

on:
  workflow_dispatch: # Allows manual trigger
    inputs:
      booking_hour:
        description: 'Booking hour (0-23)'
        required: false
        default: '7'
      booking_minute:
        description: 'Booking minute (0-59)'
        required: false
        default: '0'
      enable_recording:
        description: 'Enable video recording'
        type: boolean
        required: false
        default: true
  repository_dispatch: # Add this for cron-job.org
    types: [pickleball-booking]

jobs:
  pickleball-reservation:
    name: Pickleball Court Booking
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install dependencies
        run: |
          npm ci --production || npm install playwright dotenv
          
      - name: Install Playwright Browsers
        run: |
          npx playwright install chromium --with-deps

      - name: Create recordings directory
        run: |
          mkdir -p recordings
          echo "ðŸ“ Created recordings directory"

      - name: Run Pickleball Booking Bot
        run: |
          echo "ðŸŽ¾ Starting pickleball court booking bot..."
          echo "ðŸ“… Target booking time: ${{ github.event.inputs.booking_hour || '7' }}:${{ github.event.inputs.booking_minute || '0' }} PST"
          echo "ðŸŸï¸ Court type: Pickleball"
          echo "â° Time slots: 8-8:30pm, 8:30-9pm, 9-9:30pm, 9:30-10pm"
          echo "ðŸŽ¬ Recording enabled: ${{ github.event.inputs.enable_recording || 'true' }}"
          echo "ðŸ”— Triggered by: ${{ github.event.client_payload.triggered_by || 'GitHub Actions' }}"
          
          # Run with timeout protection
          timeout 20m node reserve.js || echo "âš ï¸ Bot execution completed or timed out"
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          EMAIL: ${{ secrets.EMAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
          USER_NAME: Khoi Do
          BOOKING_HOUR: ${{ github.event.inputs.booking_hour || '7' }}
          BOOKING_MINUTE: ${{ github.event.inputs.booking_minute || '0' }}
          ENABLE_RECORDING: ${{ github.event.inputs.enable_recording || 'true' }}
          NODE_ENV: production
          GITHUB_ACTIONS: true
          TZ: America/Los_Angeles
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: List generated files
        if: always()
        run: |
          echo "ðŸ“‚ Checking for generated files..."
          echo "ðŸ“ recordings/ directory:"
          ls -la recordings/ 2>/dev/null || echo "ðŸ“­ recordings/ directory empty or missing"
          echo "ðŸ–¼ï¸ Root directory screenshots:"
          ls -la *.png 2>/dev/null || echo "ðŸ“­ No PNG files in root"
          echo "ðŸŽ¬ Root directory videos:"
          ls -la *.webm 2>/dev/null || echo "ðŸ“­ No WEBM files in root"

          echo "ðŸ“¦ Processing artifacts..."
          
          # Create artifacts directory
          mkdir -p artifacts
          
          # Copy recordings folder contents
          if [ -d "recordings" ] && [ "$(ls -A recordings/)" ]; then
            echo "ðŸ“ Copying recordings folder..."
            cp -r recordings/* artifacts/ 2>/dev/null || true
            echo "âœ… Recordings copied"
          else
            echo "ðŸ“­ No recordings folder or empty"
          fi
          
          # Copy any root screenshots
          if ls *.png 1> /dev/null 2>&1; then
            echo "ðŸ–¼ï¸ Copying root screenshots..."
            cp *.png artifacts/ 2>/dev/null || true
            echo "âœ… Screenshots copied"
          else
            echo "ðŸ“­ No root screenshots found"
          fi
          
          # Copy any root videos
          if ls *.webm 1> /dev/null 2>&1; then
            echo "ðŸŽ¬ Copying root videos..."
            cp *.webm artifacts/ 2>/dev/null || true
            echo "âœ… Videos copied"
          else
            echo "ðŸ“­ No root videos found"
          fi
          
          # Create a detailed summary log
          echo "ðŸŽ¾ Pickleball Booking Bot Results" > artifacts/booking-summary.txt
          echo "=================================" >> artifacts/booking-summary.txt
          echo "ðŸ“… Run Date: $(date)" >> artifacts/booking-summary.txt
          echo "ðŸŽ¯ Target Time: ${{ github.event.inputs.booking_hour || '7' }}:${{ github.event.inputs.booking_minute || '0' }} PST" >> artifacts/booking-summary.txt
          echo "ðŸŸï¸ Venue: iPICKLE Cerritos" >> artifacts/booking-summary.txt
          echo "â° Time Slots: 8-8:30pm, 8:30-9pm, 9-9:30pm, 9:30-10pm" >> artifacts/booking-summary.txt
          echo "ðŸŽ¬ Recording Enabled: ${{ github.event.inputs.enable_recording || 'true' }}" >> artifacts/booking-summary.txt
          echo "ðŸ”— Triggered by: ${{ github.event.client_payload.triggered_by || 'GitHub Actions' }}" >> artifacts/booking-summary.txt
          echo "ðŸ“Š Job Status: ${{ job.status }}" >> artifacts/booking-summary.txt
          echo "âš¡ Run Number: ${{ github.run_number }}" >> artifacts/booking-summary.txt
          echo "" >> artifacts/booking-summary.txt
          
          # Add file inventory
          echo "ðŸ“‚ Generated Files:" >> artifacts/booking-summary.txt
          echo "==================" >> artifacts/booking-summary.txt
          if [ "$(ls -A artifacts/ 2>/dev/null | grep -v booking-summary.txt)" ]; then
            ls -la artifacts/ | grep -v booking-summary.txt >> artifacts/booking-summary.txt
          else
            echo "No files generated" >> artifacts/booking-summary.txt
          fi
          
          echo "" >> artifacts/booking-summary.txt
          echo "ðŸ–¥ï¸ System Info:" >> artifacts/booking-summary.txt
          echo "Runner OS: ${{ runner.os }}" >> artifacts/booking-summary.txt
          echo "Node Version: $(node --version)" >> artifacts/booking-summary.txt
          echo "Available Memory: $(free -h | grep '^Mem:' | awk '{print $7}')" >> artifacts/booking-summary.txt
          
          # Create zip if there are files
          if [ "$(ls -A artifacts/)" ]; then
            echo "ðŸ“¦ Creating zip archive..."
            zip -r pickleball-booking-results.zip artifacts/
            echo "âœ… Archive created: pickleball-booking-results.zip"
            echo "ðŸ“Š Archive size: $(ls -lh pickleball-booking-results.zip | awk '{print $5}')"
          else
            echo "ðŸ“­ No artifacts to zip"
            # Create empty summary for consistency
            echo "No files generated during this run" > booking-summary.txt
          fi

      - name: Upload Booking Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kd-report
          path: |
            pickleball-booking-results.zip
            artifacts/
            recordings/
            *.png
            *.webm
          retention-days: 30
          compression-level: 6

      - name: Upload Video Recordings (Separate)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kd-screen-recording
          path: |
            recordings/*.webm
            *.webm
          retention-days: 30
          compression-level: 1
        continue-on-error: true



      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up temporary files..."
          # Keep artifacts but clean up duplicates
          rm -f *.zip 2>/dev/null || true
          echo "âœ… Cleanup completed"