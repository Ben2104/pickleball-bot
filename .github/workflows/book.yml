name: Automatic Pickleball Reservations on PlayByPoint

on:
  schedule:
    # Runs at 6:55 AM PST (14:55 UTC) every day to catch 7 AM bookings
    - cron: '55 13 * * *'
  workflow_dispatch: # Allows manual trigger
  repository_dispatch: # Add this for cron-job.org
    types: [pickleball-booking]

jobs:
  pickleball-reservation:
    name: Pickleball Court Booking
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install playwright dotenv
          
      - name: Install Playwright Browsers
        run: |
          npx playwright install chromium --with-deps

      - name: Run Pickleball Booking Bot
        run: |
          echo "ğŸ¾ Starting pickleball court booking bot..."
          echo "ğŸ“… Target booking time: 7:00 AM PST"
          echo "ğŸŸï¸ Court type: Pickleball"
          echo "â° Time slots: 8-8:30pm, 8:30-9pm, 9-9:30pm, 9:30-10pm"
          echo "ğŸ”— Triggered by: ${{ github.event.client_payload.triggered_by || 'GitHub Actions' }}"
          node reserve.js
        env:
          EMAIL: ${{ secrets.EMAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
          BOOKING_HOUR: "18"
          BOOKING_MINUTE: "35"
          NODE_ENV: production
          GITHUB_ACTIONS: true
          TZ: America/Los_Angeles

      - name: Zip Screenshots and Logs
        if: always()
        run: |
          # Create artifacts directory
          mkdir -p artifacts
          
          # Copy any screenshots
          if [ -f "*.png" ]; then
            cp *.png artifacts/ 2>/dev/null || true
          fi
          
          # Create a summary log
          echo "ğŸ¾ Pickleball Booking Bot Results" > artifacts/booking-summary.txt
          echo "=================================" >> artifacts/booking-summary.txt
          echo "ğŸ“… Run Date: $(date)" >> artifacts/booking-summary.txt
          echo "ğŸ¯ Target Time: 7:00 AM PST" >> artifacts/booking-summary.txt
          echo "ğŸŸï¸ Venue: iPICKLE Cerritos" >> artifacts/booking-summary.txt
          echo "â° Time Slots: 8-8:30pm, 8:30-9pm, 9-9:30pm, 9:30-10pm" >> artifacts/booking-summary.txt
          echo "ğŸ”— Triggered by: ${{ github.event.client_payload.triggered_by || 'GitHub Actions' }}" >> artifacts/booking-summary.txt
          echo "ğŸ“Š Booking Status: Check job logs for details" >> artifacts/booking-summary.txt
          
          # Zip everything
          if [ "$(ls -A artifacts/)" ]; then
            zip -r pickleball-booking-results.zip artifacts/
          else
            echo "No artifacts to zip"
          fi

      - name: Upload Booking Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pickleball-booking-results-${{ github.run_number }}
          path: |
            pickleball-booking-results.zip
            *.png
          retention-days: 30

      - name: Upload Error Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots-${{ github.run_number }}
          path: "*.png"
          retention-days: 7

      - name: Notify on Success
        if: success()
        run: |
          echo "ğŸ‰ Pickleball booking bot completed successfully!"
          echo "âœ… Check the booking confirmation in your PlayByPoint account"
          echo "ğŸ“§ You should receive email confirmation if booking was successful"
          echo "ğŸ”— Triggered by: ${{ github.event.client_payload.triggered_by || 'GitHub Actions' }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Pickleball booking bot failed!"
          echo "ğŸ” Check the uploaded screenshots and logs for debugging"
          echo "ğŸ’¡ Common issues: Invalid credentials, website changes, or 403 Forbidden errors"
          echo "ğŸ”— Triggered by: ${{ github.event.client_payload.triggered_by || 'GitHub Actions' }}"